name: Deploy Frontend to prod
on:
  push:
    branches: [ prod ]
  pull_request:
    branches: [ prod ]
    types: [ closed ]

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    environment: CI/CD
    
    # Only deploy on direct push or merged PR
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    
    steps:
    - name: Deploy Frontend to VPS
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          set -e
          echo "ğŸš€ DÃ©ploiement du frontend dÃ©marrÃ©..."
          
          # Go to frontend project folder
          cd /root/projects/Breezy
          
          # Security backup (optional)
          echo "ğŸ“¦ CrÃ©ation d'un backup..."
          git stash push -m "Pre-deploy backup $(date)" || echo "No changes to stash"
          
          # Pull latest changes
          echo "ğŸ”„ RÃ©cupÃ©ration des modifications..."
          git fetch origin
          git checkout prod
          git pull origin prod
          
          # Go to backend folder for deployment
          cd ../breezy-backend
          
          # Stop and remove the frontend container completely
          echo "â¹ï¸ ArrÃªt du frontend..."
          docker compose -f docker-compose.prod-ssl.yml stop frontend || true
          docker compose -f docker-compose.prod-ssl.yml rm -f frontend || true
          
          # Remove old images (force removal and prune)
          echo "ğŸ—‘ï¸ Nettoyage des anciennes images..."
          docker rmi breezy-frontend:latest --force || true
          docker image prune -f || true
          
          # Rebuild and restart ONLY the frontend
          echo "ğŸ”¨ Reconstruction du frontend..."
          docker compose -f docker-compose.prod-ssl.yml build --no-cache frontend
          docker compose -f docker-compose.prod-ssl.yml up -d frontend
          
          # Wait for service to be ready
          echo "â³ Attente du dÃ©marrage..."
          sleep 15
          
          # Check if frontend is working
          echo "ğŸ” VÃ©rification du statut..."
          docker logs breezy-frontend-prod --tail 20
          
          # Health check with timeout
          echo "ğŸ¥ Test de santÃ©..."
          TIMEOUT=60
          COUNTER=0
          
          while [ $COUNTER -lt $TIMEOUT ]; do
            if docker compose -f docker-compose.prod-ssl.yml ps frontend | grep -q "Up\|running"; then
              echo "âœ… Frontend dÃ©ployÃ© avec succÃ¨s!"
              
              # Additional check: verify the service is responding
              if curl -f -s http://localhost:3000 > /dev/null || curl -f -s http://127.0.0.1:3000 > /dev/null; then
                echo "ğŸŒ Frontend rÃ©pond correctement!"
              else
                echo "âš ï¸ Frontend dÃ©marrÃ© mais ne rÃ©pond pas encore (normal si derriÃ¨re un proxy)"
              fi
              
              exit 0
            fi
            
            echo "Attente... ($COUNTER/$TIMEOUT)"
            sleep 2
            COUNTER=$((COUNTER + 2))
          done
          
          echo "âŒ Timeout: Le frontend n'a pas dÃ©marrÃ© dans les temps"
          echo "ğŸ“‹ Logs du conteneur:"
          docker logs breezy-frontend-prod --tail 50
          echo "ğŸ“‹ Status des conteneurs:"
          docker compose -f docker-compose.prod-ssl.yml ps
          exit 1
