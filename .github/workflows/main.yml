name: Deploy Frontend Simple
on:
  push:
    branches: [ prod ]
  pull_request:
    branches: [ prod ]
    types: [ closed ]

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    environment: CI/CD
    
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    
    steps:
    - name: Simple Fast Deployment
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          set -e
          echo "üöÄ D√©ploiement rapide d√©marr√©..."
          
          cd /root/projects/Breezy
          
          # Pull latest changes
          echo "üì¶ Mise √† jour du code..."
          git fetch origin && git checkout prod && git pull origin prod
          
          cd ../breezy-backend
          
          # Pre-build l'image AVANT d'arr√™ter le service
          echo "üî® Pre-build de l'image (service actuel continue)..."
          docker compose -f docker-compose.prod-ssl.yml build --no-cache frontend
          
          # Restart ultra-rapide (image d√©j√† pr√™te)
          echo "‚ö° Restart rapide..."
          docker compose -f docker-compose.prod-ssl.yml up -d frontend --force-recreate
          
          # V√©rification
          echo "‚úÖ V√©rification..."
          sleep 5
          
          if docker compose -f docker-compose.prod-ssl.yml ps frontend | grep -q "Up"; then
            echo "üéâ D√©ploiement r√©ussi!"
            echo "‚è±Ô∏è  Interruption r√©duite √† ~5-10 secondes"
            docker image prune -f
          else
            echo "‚ùå Probl√®me d√©tect√©"
            docker logs breezy-frontend-prod --tail 20
            exit 1
          fi
